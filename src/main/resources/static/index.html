<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spring Batch Job Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light" x-data="batchApp()">

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h1 class="card-title mb-0">
                            <i class="bi bi-gear-fill me-2"></i>Spring Batch Job Controller
                        </h1>
                    </div>
                    <div class="card-body">
                        <!-- Job Configuration Form -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="inputPath" class="form-label">Input XML Path:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-file-earmark-code"></i></span>
                                    <input type="text" id="inputPath" x-model="inputPath" class="form-control"
                                           placeholder="Enter input XML file path"/>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="outputPath" class="form-label">Output CSV Path:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
                                    <input type="text" id="outputPath" x-model="outputPath" class="form-control"
                                           placeholder="Enter output CSV file path"/>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mb-4">
                            <button @click="startJob"
                                    :disabled="isJobRunning"
                                    class="btn btn-success">
                                <i class="bi bi-play-fill me-1"></i>
                                <span x-text="isJobRunning ? 'Job Running...' : 'Start Job'"></span>
                            </button>
                            <button @click="stopPolling"
                                    class="btn btn-warning">
                                <i class="bi bi-pause-fill me-1"></i>Stop Monitoring
                            </button>
                            <button @click="clearLogs"
                                    class="btn btn-secondary">
                                <i class="bi bi-trash me-1"></i>Clear Logs
                            </button>
                        </div>

                        <!-- Job Status -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Job Status</h5>
                                    </div>
                                    <div class="card-body">
                                        <span class="badge fs-6"
                                              :class="getStatusBadgeClass(jobStatus)"
                                              x-text="jobStatus"></span>
                                        <div class="mt-2" x-show="startTime">
                                            <small class="text-muted">
                                                Started: <span x-text="formatTime(startTime)"></span>
                                            </small>
                                        </div>
                                        <div x-show="endTime">
                                            <small class="text-muted">
                                                Ended: <span x-text="formatTime(endTime)"></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Statistics</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="text-primary fs-4" x-text="proteinCount"></div>
                                                <small class="text-muted">Proteins</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-success fs-4" x-text="peptideCount"></div>
                                                <small class="text-muted">Peptides</small>
                                            </div>
                                        </div>
                                        <div class="mt-3" x-show="proteinCount > 0">
                                            <div class="progress">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                     :style="'width: ' + getProgressPercentage() + '%'"
                                                     x-text="getProgressPercentage() + '%'"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Log -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>Progress Log</h5>
                                <span class="badge bg-info" x-text="progressLog.length + ' entries'"></span>
                            </div>
                            <div class="card-body p-0">
                                <div class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace;">
                                    <template x-for="(log, index) in progressLog" :key="index">
                                        <div class="mb-1" x-text="log"></div>
                                    </template>
                                    <div x-show="progressLog.length === 0" class="text-muted">
                                        No progress logs yet...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function batchApp() {
            return {
                inputPath: '/media/tag/D/digested-db/uniprot_sprot.xml.gz',
                outputPath: '/media/tag/D/digested-db/uniprot_sprot.xml.gz.csv',
                jobStatus: 'Not Started',
                progressLog: [],
                proteinCount: 0,
                peptideCount: 0,
                isJobRunning: false,
                startTime: null,
                endTime: null,
                statusPollingInterval: null,
                progressPollingInterval: null,

                startJob() {
                    if (!this.inputPath || !this.outputPath) {
                        alert('Please provide both input and output paths');
                        return;
                    }

                    this.isJobRunning = true;
                    this.clearLogs();

                    fetch(`/job/start?inputPath=${encodeURIComponent(this.inputPath)}&outputPath=${encodeURIComponent(this.outputPath)}`, {
                        method: 'POST'
                    })
                    .then(resp => resp.text())
                    .then(msg => {
                        this.jobStatus = 'STARTED';
                        this.progressLog.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
                        this.startPolling();
                    })
                    .catch(err => {
                        this.jobStatus = 'ERROR';
                        this.isJobRunning = false;
                        this.progressLog.push(`[${new Date().toLocaleTimeString()}] Error: ${err}`);
                    });
                },

                startPolling() {
                    this.stopPolling(); // Clear any existing intervals

                    this.statusPollingInterval = setInterval(() => {
                        this.pollStatus();
                    }, 2000);

                    this.progressPollingInterval = setInterval(() => {
                        this.pollProgress();
                    }, 1000);
                },

                stopPolling() {
                    if (this.statusPollingInterval) {
                        clearInterval(this.statusPollingInterval);
                        this.statusPollingInterval = null;
                    }
                    if (this.progressPollingInterval) {
                        clearInterval(this.progressPollingInterval);
                        this.progressPollingInterval = null;
                    }
                },

                pollStatus() {
                    fetch('/job/status')
                        .then(res => res.json())
                        .then(status => {
                            this.jobStatus = status.status || 'UNKNOWN';
                            this.startTime = status.startTime;
                            this.endTime = status.endTime;

                            if (status.status === 'COMPLETED' || status.status === 'FAILED') {
                                this.isJobRunning = false;
                                this.stopPolling();
                            }
                        })
                        .catch(err => {
                            console.error('Status polling error:', err);
                        });
                },

                pollProgress() {
                    fetch('/progress')
                        .then(res => res.json())
                        .then(log => {
                            this.progressLog = log;

                            // Extract statistics from the last log entry
                            if (log.length > 0) {
                                let lastLog = log[log.length - 1];
                                let matches = lastLog.match(/Processed (\d+) proteins, (\d+) peptides/);
                                if (matches) {
                                    this.proteinCount = parseInt(matches[1]);
                                    this.peptideCount = parseInt(matches[2]);
                                }
                            }
                        })
                        .catch(err => {
                            console.error('Progress polling error:', err);
                        });
                },

                clearLogs() {
                    this.progressLog = [];
                    this.proteinCount = 0;
                    this.peptideCount = 0;
                },

                getStatusBadgeClass(status) {
                    switch (status) {
                        case 'COMPLETED': return 'bg-success';
                        case 'FAILED': return 'bg-danger';
                        case 'STARTED':
                        case 'STARTING': return 'bg-primary';
                        case 'STOPPING': return 'bg-warning';
                        case 'STOPPED': return 'bg-secondary';
                        default: return 'bg-secondary';
                    }
                },

                formatTime(timestamp) {
                    if (!timestamp) return '';
                    return new Date(timestamp).toLocaleString();
                },

                getProgressPercentage() {
                    // Simple percentage calculation based on protein count
                    // You can adjust this based on your expected total
                    const estimated = 100000; // Adjust based on your data
                    return Math.min(100, Math.round((this.proteinCount / estimated) * 100));
                }
            }
        }
    </script>
</body>
</html>
